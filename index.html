<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="NumRun - Szybka gra matematyczna. Trenuj umysł i zdobywaj punkty!">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NumRun">
    <title>NumRun - Gra Matematyczna</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" href="/icon-192.svg">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }

        .game-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            position: relative;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .timer-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .timer-bar {
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            height: 8px;
            border-radius: 4px;
            transition: width 0.1s linear;
            position: relative;
        }

        .timer-text {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .level-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin-bottom: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .multiplier {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #000;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .equation {
            font-size: 3rem;
            margin: 30px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .answers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 30px 0;
        }

        .answer-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.5rem;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .answer-btn:hover::before {
            left: 100%;
        }

        .answer-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .answer-btn.correct {
            background: rgba(34, 197, 94, 0.8);
            border-color: #22c55e;
            animation: correctPulse 0.6s ease-out;
        }

        .answer-btn.wrong {
            background: rgba(239, 68, 68, 0.8);
            border-color: #ef4444;
            animation: wrongShake 0.5s ease-out;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .feedback {
            font-size: 1.5rem;
            margin: 20px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            text-align: center;
        }

        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #fbbf24;
            border-radius: 50%;
            animation: particleFloat 2s ease-out forwards;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(0);
                opacity: 0;
            }
        }

        .shield-container {
            display: inline-block;
            font-size: 1.5rem;
            margin-top: 5px;
        }

        .shield-icon {
            display: inline-block;
            margin: 0 2px;
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8));
        }

        @keyframes shieldGain {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        @keyframes shieldBreak {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            25% {
                transform: scale(1.3) rotate(-15deg);
            }
            50% {
                transform: scale(1.3) rotate(15deg);
            }
            75% {
                transform: scale(0.8) rotate(-15deg);
                opacity: 0.5;
            }
            100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
        }

        @keyframes shieldPulse {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.8));
            }
            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 15px rgba(16, 185, 129, 1));
            }
        }

        .shield-gain {
            animation: shieldGain 0.6s ease-out;
            will-change: transform, opacity;
        }

        .shield-break {
            animation: shieldBreak 0.5s ease-out forwards;
            will-change: transform, opacity;
        }

        .shield-active {
            animation: shieldPulse 2s ease-in-out infinite;
            will-change: transform, filter;
        }

        /* Lepsze wsparcie dla mobile */
        @media (max-width: 480px) {
            .shield-icon {
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
                backface-visibility: hidden;
                -webkit-backface-visibility: hidden;
            }
        }

        .stats-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }

        .stats-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9rem;
        }

        .quit-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .quit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .skip-btn {
            background: linear-gradient(45deg, #8b5cf6, #a855f7);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .skip-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        .skip-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Auth Styles */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn-primary {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .auth-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .auth-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .auth-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .auth-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            color: #6ee7b7;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .auth-divider {
            text-align: center;
            margin: 20px 0;
            opacity: 0.6;
            font-size: 0.9rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
        }

        .profile-stat {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logout-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 20px;
                min-width: 90%;
                max-width: 95%;
            }

            h1 {
                font-size: 2rem;
            }

            .equation {
                font-size: 1.8rem;
            }

            .answer-btn {
                font-size: 1.1rem;
                padding: 18px 10px;
                min-height: 60px;
            }

            .stats {
                grid-template-columns: 1fr;
                gap: 10px;
                font-size: 0.9rem;
            }

            .mode-btn {
                font-size: 1rem !important;
                padding: 15px !important;
            }

            .feedback {
                font-size: 1rem;
                min-height: 40px;
                padding: 0 10px;
                line-height: 1.3;
            }

            .timer-text {
                font-size: 1rem;
            }
        }

        @media (max-width: 360px) {
            .game-container {
                padding: 15px;
            }

            .equation {
                font-size: 1.5rem;
            }

            .answer-btn {
                font-size: 1rem;
                padding: 15px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container" id="gameContainer">
        <h1>NumRun</h1>
        
        <!-- Auth Screen -->
        <div class="auth-screen" id="authScreen" style="display: none;">
            <!-- Login/Register will be rendered here -->
        </div>

        <!-- Main Menu -->
        <div class="mode-selection" id="modeSelection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-size: 1.8rem; margin: 0;">Wybierz tryb gry</h2>
                <button onclick="showProfile()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-size: 0.9rem;">
                    👤 Profil
                </button>
            </div>

            <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                <button class="mode-btn" onclick="(async () => await startGame('timed'))()" style="background: linear-gradient(45deg, #ef4444, #dc2626); border: none; color: white; padding: 20px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; transition: transform 0.3s;">
                    ⚡ Szybka Runda
                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">30 sekund na jak najwięcej punktów!</div>
                </button>

                <button class="mode-btn" onclick="(async () => await startGame('relaxed'))()" style="background: linear-gradient(45deg, #10b981, #059669); border: none; color: white; padding: 20px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; transition: transform 0.3s;">
                    🧘 Tryb Relaks
                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">Bez limitu czasu, trenuj w spokoju</div>
                </button>

                <button class="mode-btn" onclick="(async () => await startGame('daily'))()" style="background: linear-gradient(45deg, #f59e0b, #d97706); border: none; color: white; padding: 20px; border-radius: 15px; font-size: 1.2rem; cursor: pointer; transition: transform 0.3s;">
                    🌟 Daily Challenge
                    <div style="font-size: 0.9rem; margin-top: 5px; opacity: 0.9;">Codzienne wyzwanie - rywalizuj z innymi!</div>
                </button>

                <button class="mode-btn" onclick="showLeaderboard()" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed); border: none; color: white; padding: 15px; border-radius: 15px; font-size: 1rem; cursor: pointer; transition: transform 0.3s;">
                    🏆 Ranking
                </button>

                <button class="mode-btn" onclick="showAchievements()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px; border-radius: 15px; font-size: 1rem; cursor: pointer; transition: transform 0.3s;">
                    🎖️ Osiągnięcia
                </button>
            </div>

            <div style="font-size: 0.9rem; opacity: 0.8;">
                💡 W obu trybach zbierasz punkty i odblokujesz nowe poziomy!
            </div>
        </div>
        
        <div class="timer-container" id="timerContainer" style="display: none;">
            <div class="timer-text">Czas: <span id="timeLeft">30</span>s</div>
            <div class="timer-bar" id="timerBar" style="width: 100%"></div>
        </div>
        
        <div class="level-info" id="levelInfo" style="display: none;">
            <span>Poziom: <span id="level">1</span></span>
            <button onclick="showLevelSelector()" id="changeLevelBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; margin-left: 10px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; display: none;">
                📚 Zmień poziom
            </button>
        </div>
        
        <div class="stats" id="statsDisplay" style="display: none;">
            <div class="stat-item">
                Punkty: <span id="score">0</span>
                <div id="multiplierDisplay"></div>
            </div>
            <div class="stat-item">
                Streak: <span id="streak">0</span> 🔥
                <div id="shieldDisplay"></div>
            </div>
            <div class="stat-item">
                Najlepszy: <span id="bestScore">0</span>
            </div>
        </div>
        
        <div class="equation" id="equation" style="display: none;">5 + 3 = ?</div>
        
        <div class="answers" id="answers" style="display: none;">
            <button class="answer-btn">8</button>
            <button class="answer-btn">7</button>
            <button class="answer-btn">9</button>
            <button class="answer-btn">6</button>
        </div>
        
        <div class="feedback" id="feedback" style="display: none;"></div>
        
        <button class="skip-btn" id="skipBtn" onclick="skipQuestion()" disabled style="display: none;">
            Pomiń pytanie (0 dostępne)
        </button>
        
        <button class="quit-btn" id="quitBtn" onclick="quitGame()" style="display: none;">
            🚪 Zakończ grę
        </button>

        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stats-title">📊 Statystyki</div>
            <div class="stats-grid">
                <div>Poprawne odpowiedzi: <span id="correctAnswers">0</span></div>
                <div>Błędne odpowiedzi: <span id="wrongAnswers">0</span></div>
                <div>Procent poprawnych: <span id="accuracy">100%</span></div>
                <div>Średni czas: <span id="avgTime">0s</span></div>
                <div>Najszybsza odpowiedź: <span id="fastestTime">∞</span></div>
                <div>Najdłuższy streak: <span id="maxStreak">0</span></div>
            </div>
        </div>
    </div>

    <script>
        // ============ SUPABASE CONFIG ============
        const SUPABASE_URL = 'https://fdwzrxmbktkrztlapxfn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkd3pyeG1ia3Rrcnp0bGFweGZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzODUxODcsImV4cCI6MjA3NDk2MTE4N30.lQmCfEOuTDjkA6m8U_uhaICxCF0_648Mjt3l6h--3qA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============ USER SESSION ============
        let currentUser = null;

        let score = 0;
        let streak = 0;
        let level = 1;
        let correctAnswer = 0;
        let gameActive = false;
        let timeLeft = 30;
        let timer = null;
        let questionStartTime = 0;
        let pointMultiplier = 1;
        let multiplierEndTime = 0;
        let skipsAvailable = 0;
        let shields = 0; // Tarcze ochronne
        let gameMode = null;

        let stats = {
            correctAnswers: 0,
            wrongAnswers: 0,
            totalTime: 0,
            fastestTime: Infinity,
            maxStreak: 0,
            gamesPlayed: 0
        };

        const levels = [
            { min: 1, max: 10, operations: ['+', '-'] },
            { min: 1, max: 50, operations: ['+', '-'] },
            { min: 1, max: 100, operations: ['+', '-'] },
            { min: 2, max: 12, operations: ['×'] },
            { min: 5, max: 20, operations: ['×'] },
            { min: 2, max: 12, operations: ['÷'] },
            { min: -20, max: 20, operations: ['+', '-'] },
            { min: 1, max: 10, operations: ['ułamek'] },
            { min: 10, max: 99, operations: ['×'] },
            { min: 100, max: 999, operations: ['+', '-'] },
            { min: 1, max: 20, operations: ['kwadrat'] },
            { min: 1, max: 144, operations: ['pierwiastek'] },
            { min: 2, max: 20, operations: ['potęga'] },
            { min: -50, max: 50, operations: ['×'] },
            { min: 10, max: 99, operations: ['÷'] },
            { min: 1, max: 15, operations: ['mieszane'] },
            { min: 100, max: 999, operations: ['×'] },
            { min: 1, max: 20, operations: ['procent'] },
            { min: 1, max: 100, operations: ['NWD'] },
            { min: 1000, max: 9999, operations: ['+', '-'] }
        ];

        async function startGame(mode) {
            // Sprawdź czy gracz ma nick, jeśli nie - zapytaj
            if (!localStorage.getItem('playerName')) {
                await askForPlayerName();
            }

            gameMode = mode;
            document.getElementById('modeSelection').style.display = 'none';

            if (mode === 'relaxed') {
                showLevelSelector();
            } else {
                level = 1;
                startGameplay();
            }
        }

        function startGameplay() {
            document.getElementById('levelInfo').style.display = 'block';
            document.getElementById('statsDisplay').style.display = 'grid';
            document.getElementById('equation').style.display = 'block';
            document.getElementById('answers').style.display = 'grid';
            document.getElementById('feedback').style.display = 'flex';
            document.getElementById('skipBtn').style.display = 'block';
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('quitBtn').style.display = 'block';
            
            if (gameMode === 'relaxed') {
                document.getElementById('changeLevelBtn').style.display = 'inline-block';
            }
            
            if (gameMode === 'timed') {
                document.getElementById('timerContainer').style.display = 'block';
                startTimer();
            }
            
            gameActive = true;
            newQuestion();
        }

        function quitGame() {
            if (confirm('Czy na pewno chcesz zakończyć grę? Twój postęp zostanie zapisany.')) {
                clearInterval(timer);
                gameActive = false;
                saveStats();
                showGameEndScreen('🚪 Gra zakończona');
            }
        }

        function loadStats() {
            const saved = localStorage.getItem('quickMathStats');
            if (saved) {
                stats = { ...stats, ...JSON.parse(saved) };
            }
        }

        function saveStats() {
            localStorage.setItem('quickMathStats', JSON.stringify(stats));
            const currentBest = parseInt(localStorage.getItem('quickMathBestScore') || '0');
            if (score > currentBest) {
                localStorage.setItem('quickMathBestScore', score.toString());
                document.getElementById('bestScore').textContent = score;
            }
        }

        function startTimer() {
            if (gameMode !== 'timed') return;
            
            timeLeft = 30;
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            document.getElementById('timeLeft').textContent = timeLeft;
            // Dynamiczna skala: 0-45s = 0-100%
            const percentage = Math.min((timeLeft / 45) * 100, 100);
            document.getElementById('timerBar').style.width = percentage + '%';
        }

        function timeUp() {
            clearInterval(timer);
            gameActive = false;
            saveStats();
            showGameEndScreen('⏰ Czas minął!');
        }

        function generateEquation() {
            const currentLevel = levels[Math.min(level - 1, levels.length - 1)];
            const operation = currentLevel.operations[Math.floor(Math.random() * currentLevel.operations.length)];
            
            let num1 = Math.floor(Math.random() * (currentLevel.max - currentLevel.min + 1)) + currentLevel.min;
            let num2 = Math.floor(Math.random() * (currentLevel.max - currentLevel.min + 1)) + currentLevel.min;
            
            let equation, answer;
            
            if (operation === 'ułamek') {
                const denominators = [2, 3, 4, 5, 6, 8, 10];
                const denom = denominators[Math.floor(Math.random() * denominators.length)];
                const numerator = Math.floor(Math.random() * denom) + 1;
                equation = `${numerator}/${denom} = ?`;
                answer = parseFloat((numerator / denom).toFixed(2));
            } else if (operation === '÷') {
                answer = Math.floor(Math.random() * (currentLevel.max - currentLevel.min + 1)) + currentLevel.min;
                num2 = Math.floor(Math.random() * 10) + 1;
                num1 = answer * num2;
                equation = `${num1} ÷ ${num2} = ?`;
            } else if (operation === 'kwadrat') {
                equation = `${num1}² = ?`;
                answer = num1 * num1;
            } else if (operation === 'pierwiastek') {
                const squares = [1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144];
                const square = squares[Math.floor(Math.random() * squares.length)];
                equation = `√${square} = ?`;
                answer = Math.sqrt(square);
            } else if (operation === 'potęga') {
                const base = Math.floor(Math.random() * 10) + 2;
                const exp = Math.random() < 0.5 ? 2 : 3;
                equation = `${base}^${exp} = ?`;
                answer = Math.pow(base, exp);
            } else if (operation === 'mieszane') {
                const ops = ['+', '-', '×', '÷'];
                const randOp = ops[Math.floor(Math.random() * ops.length)];
                return generateEquationForOperation(randOp, num1, num2);
            } else if (operation === 'procent') {
                const percent = [10, 20, 25, 50, 75];
                const p = percent[Math.floor(Math.random() * percent.length)];
                equation = `${p}% z ${num1*10} = ?`;
                answer = (p / 100) * (num1 * 10);
            } else if (operation === 'NWD') {
                num1 = Math.floor(Math.random() * 20) + 10;
                num2 = Math.floor(Math.random() * 20) + 10;
                equation = `NWD(${num1}, ${num2}) = ?`;
                answer = gcd(num1, num2);
            } else {
                return generateEquationForOperation(operation, num1, num2);
            }
            
            return { equation, answer };
        }

        function generateEquationForOperation(operation, num1, num2) {
            let equation, answer;
            
            if (operation === '-' && level < 7 && num1 < num2) {
                [num1, num2] = [num2, num1];
            }
            
            switch(operation) {
                case '+':
                    equation = `${num1} + ${num2} = ?`;
                    answer = num1 + num2;
                    break;
                case '-':
                    equation = `${num1} - ${num2} = ?`;
                    answer = num1 - num2;
                    break;
                case '×':
                    equation = `${num1} × ${num2} = ?`;
                    answer = num1 * num2;
                    break;
                case '÷':
                    answer = Math.floor(Math.random() * 12) + 1;
                    num1 = answer * num2;
                    equation = `${num1} ÷ ${num2} = ?`;
                    break;
            }
            
            return { equation, answer };
        }

        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        function generateAnswers(correct) {
            const answers = [correct];
            
            while(answers.length < 4) {
                let wrong;
                
                if (typeof correct === 'number' && correct % 1 === 0) {
                    if (Math.random() < 0.5) {
                        wrong = correct + (Math.floor(Math.random() * 10) - 5);
                    } else {
                        wrong = Math.floor(Math.random() * Math.max(correct * 2, 20));
                    }
                } else {
                    wrong = parseFloat((Math.random() * 2).toFixed(2));
                }
                
                if (wrong !== correct && wrong >= (level < 7 ? 0 : -100) && !answers.includes(wrong)) {
                    answers.push(wrong);
                }
            }
            
            return answers.sort(() => Math.random() - 0.5);
        }

        function newQuestion() {
            if (!gameActive) return;
            
            const { equation, answer } = generateEquation();
            correctAnswer = answer;
            questionStartTime = Date.now();
            
            document.getElementById('equation').textContent = equation;
            
            const answers = generateAnswers(answer);
            const answerButtons = document.querySelectorAll('.answer-btn');
            
            answers.forEach((ans, index) => {
                answerButtons[index].textContent = ans;
                answerButtons[index].onclick = () => checkAnswer(ans);
                answerButtons[index].className = 'answer-btn';
            });
            
            document.getElementById('feedback').textContent = '';
        }

        function checkAnswer(selectedAnswer) {
            if (!gameActive) return;
            
            const responseTime = (Date.now() - questionStartTime) / 1000;
            gameActive = false;
            const buttons = document.querySelectorAll('.answer-btn');
            
            buttons.forEach(btn => {
                const value = parseFloat(btn.textContent);
                if (Math.abs(value - correctAnswer) < 0.01) {
                    btn.classList.add('correct');
                    btn.innerHTML = `${btn.textContent} ✓`;
                } else if (Math.abs(value - selectedAnswer) < 0.01 && Math.abs(value - correctAnswer) >= 0.01) {
                    btn.classList.add('wrong');
                    btn.innerHTML = `${btn.textContent} ✗`;
                }
            });
            
            if (Math.abs(selectedAnswer - correctAnswer) < 0.01) {
                let points = 10;
                let timeBonus = 2; // Bazowy bonus czasu

                if (responseTime < 3) {
                    points += 5;
                    timeBonus = 3; // Szybka odpowiedź
                }
                if (responseTime < 1.5) {
                    points += 10;
                    timeBonus = 5; // Bardzo szybka odpowiedź
                }

                points *= pointMultiplier;

                // Dodaj czas tylko w trybie timed (max 45s)
                if (gameMode === 'timed') {
                    timeLeft = Math.min(timeLeft + timeBonus, 45);
                }

                score += points;
                streak++;
                stats.correctAnswers++;
                stats.totalTime += responseTime;

                if (responseTime < stats.fastestTime) {
                    stats.fastestTime = responseTime;
                }

                if (streak > stats.maxStreak) {
                    stats.maxStreak = streak;
                }

                // Pokaż bonus czasu w feedback
                let feedbackText = `Świetnie! +${points} pkt`;
                if (gameMode === 'timed') {
                    feedbackText += ` +${timeBonus}s ⏱️`;
                }
                document.getElementById('feedback').textContent = feedbackText + ' 🎉';

                createParticles();

                // Sprawdź milestone bonusy (nie nadpisuj głównego feedbacku z czasem)
                if (streak === 3 && gameMode === 'timed') {
                    timeLeft = Math.min(timeLeft + 5, 45);
                    document.getElementById('feedback').textContent += ' | Bonus streak! +5s 🔥';
                } else if (streak === 5) {
                    shields = Math.min(shields + 1, 2); // Max 2 tarcze
                    pointMultiplier = 2;
                    multiplierEndTime = Date.now() + 10000;
                    document.getElementById('feedback').textContent += ' | Tarcza + x2! 🛡️🌟';
                    // Animacja pojawienia się tarczy
                    setTimeout(() => updateShieldDisplay(true, 'gain'), 100);
                } else if (streak === 10) {
                    skipsAvailable++;
                    document.getElementById('feedback').textContent += ' | +Przejście! ⭐';
                }

                if (gameMode === 'timed' && score >= level * 150 && level < levels.length) {
                    level++;
                    document.getElementById('feedback').textContent += ` | Poziom ${level}! 🚀`;
                }
            } else {
                // Błędna odpowiedź

                // Użyj tarczy jeśli dostępna
                if (shields > 0) {
                    // Animacja rozbicia tarczy
                    animateShieldBreak();
                    shields--;
                    document.getElementById('feedback').textContent = 'Ochroniona tarcza! 🛡️✨';
                    // Nie resetuj streak ani nie zabieraj czasu
                } else {
                    // Brak tarczy - normalna kara
                    streak = 0;
                    stats.wrongAnswers++;

                    // Kara -5s w trybie timed
                    if (gameMode === 'timed') {
                        timeLeft = Math.max(timeLeft - 5, 0);
                        document.getElementById('feedback').textContent = 'Błąd! -5s ⏱️ 💪';
                    } else {
                        document.getElementById('feedback').textContent = 'Spróbuj ponownie! 💪';
                    }

                    document.getElementById('gameContainer').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('gameContainer').classList.remove('shake');
                    }, 500);
                }
            }
            
            updateStats();
            updateMultiplierDisplay();
            updateShieldDisplay();
            updateSkipButton();
            
            setTimeout(() => {
                gameActive = true;
                newQuestion();
            }, 1500);
        }

        function skipQuestion() {
            if (skipsAvailable > 0 && gameActive) {
                skipsAvailable--;
                updateSkipButton();
                newQuestion();
            }
        }

        function updateSkipButton() {
            const btn = document.getElementById('skipBtn');
            btn.textContent = `Pomiń pytanie (${skipsAvailable} dostępne)`;
            btn.disabled = skipsAvailable === 0;
        }

        function createParticles() {
            const container = document.querySelector('.game-container');
            const rect = container.getBoundingClientRect();
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = (rect.left + rect.width / 2 + (Math.random() - 0.5) * 100) + 'px';
                particle.style.top = (rect.top + rect.height / 2) + 'px';
                particle.style.backgroundColor = ['#fbbf24', '#10b981', '#3b82f6', '#8b5cf6'][Math.floor(Math.random() * 4)];
                
                document.body.appendChild(particle);
                
                setTimeout(() => particle.remove(), 2000);
            }
        }

        function updateMultiplierDisplay() {
            const display = document.getElementById('multiplierDisplay');
            if (Date.now() < multiplierEndTime) {
                display.innerHTML = `<div class="multiplier">x${pointMultiplier}</div>`;
            } else {
                pointMultiplier = 1;
                display.innerHTML = '';
            }
        }

        function updateShieldDisplay(animate = false, animationType = 'active') {
            const display = document.getElementById('shieldDisplay');
            if (shields > 0) {
                let shieldHTML = '<div class="shield-container">';
                for (let i = 0; i < shields; i++) {
                    const animClass = animate && i === shields - 1 && animationType === 'gain' ? 'shield-gain' : 'shield-active';
                    shieldHTML += `<span class="shield-icon ${animClass}">🛡️</span>`;
                }
                shieldHTML += '</div>';
                display.innerHTML = shieldHTML;
            } else {
                display.innerHTML = '';
            }
        }

        function animateShieldBreak() {
            const display = document.getElementById('shieldDisplay');
            const shieldIcons = display.querySelectorAll('.shield-icon');
            if (shieldIcons.length > 0) {
                const lastShield = shieldIcons[shieldIcons.length - 1];
                lastShield.classList.remove('shield-active');
                lastShield.classList.add('shield-break');

                setTimeout(() => {
                    updateShieldDisplay();
                }, 500);
            }
        }

        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('streak').textContent = streak;
            document.getElementById('level').textContent = level;
            document.getElementById('correctAnswers').textContent = stats.correctAnswers;
            document.getElementById('wrongAnswers').textContent = stats.wrongAnswers;
            
            const total = stats.correctAnswers + stats.wrongAnswers;
            const accuracy = total > 0 ? Math.round((stats.correctAnswers / total) * 100) : 100;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            const avgTime = stats.correctAnswers > 0 ? (stats.totalTime / stats.correctAnswers).toFixed(1) : 0;
            document.getElementById('avgTime').textContent = avgTime + 's';

            const fastest = (stats.fastestTime === Infinity || stats.fastestTime === null || stats.fastestTime === undefined) ? '∞' : stats.fastestTime.toFixed(1) + 's';
            document.getElementById('fastestTime').textContent = fastest;
            
            document.getElementById('maxStreak').textContent = stats.maxStreak;
const bestScore = localStorage.getItem('quickMathBestScore') || '0';
            document.getElementById('bestScore').textContent = bestScore;
        }

        function showGameEndScreen(title) {
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('levelInfo').style.display = 'none';
            document.getElementById('statsDisplay').style.display = 'none';
            document.getElementById('equation').style.display = 'none';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('quitBtn').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            
            const gameOverScreen = `
                <div style="text-align: center;">
                    <h2 style="font-size: 2rem; margin-bottom: 20px; color: #fbbf24;">${title}</h2>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px;">
                        <div style="font-size: 1.5rem; margin-bottom: 15px;">Twój wynik:</div>
                        <div style="font-size: 3rem; font-weight: bold; color: #10b981; margin-bottom: 10px;">${score}</div>
                        <div style="font-size: 1rem; opacity: 0.8;">punktów</div>
                        
                        <div style="margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                            <div>Poziom osiągnięty: <strong>${level}</strong></div>
                            <div>Najdłuższy streak: <strong>${streak > stats.maxStreak ? streak : stats.maxStreak}</strong></div>
                            <div>Poprawne odpowiedzi: <strong>${stats.correctAnswers}</strong></div>
                            <div>Błędne odpowiedzi: <strong>${stats.wrongAnswers}</strong></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        <button onclick="restartGame()" style="background: linear-gradient(45deg, #ef4444, #dc2626); border: none; color: white; padding: 15px 30px; border-radius: 15px; font-size: 1.1rem; cursor: pointer; transition: transform 0.3s;">
                            🔄 Spróbuj jeszcze raz
                        </button>

                        <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; font-size: 1.1rem; cursor: pointer; transition: transform 0.3s;">
                            🏠 Powrót do menu
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                ${gameOverScreen}
            `;
        }
        
        function showLevelSelector() {
            gameActive = false;
            clearInterval(timer);
            
            const levelDescriptions = [
                "Dodawanie i odejmowanie 1-10",
                "Dodawanie i odejmowanie 1-50", 
                "Dodawanie i odejmowanie 1-100",
                "Mnożenie małe (2×12)",
                "Mnożenie średnie (5×20)",
                "Dzielenie proste",
                "Liczby ujemne",
                "Ułamki dziesiętne",
                "Duże mnożenie (10×99)",
                "Liczby 3-cyfrowe",
                "Kwadraty (n²)",
                "Pierwiastki (√n)",
                "Potęgi (n³)",
                "Mnożenie z ujemnymi",
                "Trudne dzielenie",
                "Wszystkie operacje",
                "Bardzo duże mnożenie",
                "Procenty (%)",
                "NWD - Wspólny dzielnik",
                "Liczby 4-cyfrowe"
            ];
            
            let levelButtons = '';
            for (let i = 1; i <= levels.length; i++) {
                const unlocked = gameMode === 'relaxed' || score >= (i-1) * 150 || i <= level;
                const buttonStyle = unlocked 
                    ? 'background: rgba(34, 197, 94, 0.3); border: 1px solid #22c55e; cursor: pointer;'
                    : 'background: rgba(100, 100, 100, 0.3); border: 1px solid #666; cursor: not-allowed; opacity: 0.5;';
                
                const clickHandler = unlocked ? `selectLevel(${i})` : '';
                
                levelButtons += `
                    <button ${unlocked ? `onclick="${clickHandler}"` : ''} 
                            style="${buttonStyle} color: white; padding: 10px; border-radius: 10px; font-size: 0.9rem; text-align: left;">
                        <div style="font-weight: bold;">Poziom ${i}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${levelDescriptions[i-1]}</div>
                        ${!unlocked ? '<div style="font-size: 0.7rem; color: #fbbf24;">🔒 Wymagane: ' + ((i-1) * 150) + ' pkt</div>' : ''}
                    </button>
                `;
            }
            
            const title = gameMode === 'relaxed' ? '🧘 Wybierz poziom do treningu' : '📚 Wybierz poziom';
            const subtitle = gameMode === 'relaxed' ? 'Wszystkie poziomy dostępne!' : 'Odblokuj nowe poziomy zdobywając punkty';
            
            const levelSelector = `
                <div style="text-align: center;">
                    <h2 style="margin-bottom: 10px;">${title}</h2>
                    <p style="opacity: 0.8; margin-bottom: 20px; font-size: 0.9rem;">${subtitle}</p>
                    
                    <div style="max-height: 400px; overflow-y: auto; display: grid; gap: 10px; margin-bottom: 20px;">
                        ${levelButtons}
                    </div>
                    
                    <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer;">
                        ⬅️ Powrót do menu
                    </button>
                </div>
            `;
            
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('levelInfo').style.display = 'none';
            document.getElementById('statsDisplay').style.display = 'none';
            document.getElementById('equation').style.display = 'none';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('quitBtn').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';
            
            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                ${levelSelector}
            `;
        }
        
        function selectLevel(newLevel) {
            level = newLevel;

            // Ukryj selektor poziomu i zacznij grę
            document.getElementById('timerContainer').style.display = 'none';
            document.getElementById('levelInfo').style.display = 'none';
            document.getElementById('statsDisplay').style.display = 'none';
            document.getElementById('equation').style.display = 'none';
            document.getElementById('answers').style.display = 'none';
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('skipBtn').style.display = 'none';
            document.getElementById('quitBtn').style.display = 'none';
            document.getElementById('statsPanel').style.display = 'none';

            // Reset gry
            score = 0;
            streak = 0;
            shields = 0;
            skipsAvailable = 0;
            pointMultiplier = 1;

            startGameplay();
        }

        function restartGame() {
            // Resetuj wszystkie zmienne
            score = 0;
            streak = 0;
            shields = 0;
            skipsAvailable = 0;
            pointMultiplier = 1;
            multiplierEndTime = 0;
            gameActive = false;

            // Resetuj statystyki sesji (ale nie globalne)
            const sessionStats = {
                correctAnswers: 0,
                wrongAnswers: 0,
                totalTime: 0,
                fastestTime: Infinity,
                maxStreak: 0
            };

            // Zachowaj globalne statystyki
            const savedGamesPlayed = stats.gamesPlayed;
            stats = { ...sessionStats, gamesPlayed: savedGamesPlayed };

            // Usuń poprzedni ekran końcowy
            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                <div class="timer-container" id="timerContainer" style="display: none;">
                    <div class="timer-text">Czas: <span id="timeLeft">30</span>s</div>
                    <div class="timer-bar" id="timerBar" style="width: 100%"></div>
                </div>

                <div class="level-info" id="levelInfo" style="display: none;">
                    <span>Poziom: <span id="level">1</span></span>
                    <button onclick="showLevelSelector()" id="changeLevelBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; margin-left: 10px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; display: none;">
                        📚 Zmień poziom
                    </button>
                </div>

                <div class="stats" id="statsDisplay" style="display: none;">
                    <div class="stat-item">
                        Punkty: <span id="score">0</span>
                        <div id="multiplierDisplay"></div>
                    </div>
                    <div class="stat-item">
                        Streak: <span id="streak">0</span> 🔥
                        <div id="shieldDisplay"></div>
                    </div>
                    <div class="stat-item">
                        Najlepszy: <span id="bestScore">0</span>
                    </div>
                </div>

                <div class="equation" id="equation" style="display: none;">5 + 3 = ?</div>

                <div class="answers" id="answers" style="display: none;">
                    <button class="answer-btn">8</button>
                    <button class="answer-btn">7</button>
                    <button class="answer-btn">9</button>
                    <button class="answer-btn">6</button>
                </div>

                <div class="feedback" id="feedback" style="display: none;"></div>

                <button class="skip-btn" id="skipBtn" onclick="skipQuestion()" disabled style="display: none;">
                    Pomiń pytanie (0 dostępne)
                </button>

                <button class="quit-btn" id="quitBtn" onclick="quitGame()" style="display: none;">
                    🚪 Zakończ grę
                </button>

                <div class="stats-panel" id="statsPanel" style="display: none;">
                    <div class="stats-title">📊 Statystyki</div>
                    <div class="stats-grid">
                        <div>Poprawne odpowiedzi: <span id="correctAnswers">0</span></div>
                        <div>Błędne odpowiedzi: <span id="wrongAnswers">0</span></div>
                        <div>Procent poprawnych: <span id="accuracy">100%</span></div>
                        <div>Średni czas: <span id="avgTime">0s</span></div>
                        <div>Najszybsza odpowiedź: <span id="fastestTime">∞</span></div>
                        <div>Najdłuższy streak: <span id="maxStreak">0</span></div>
                    </div>
                </div>
            `;

            // Rozpocznij tę samą grę ponownie
            if (gameMode === 'timed' || gameMode === 'daily') {
                startGameplay();
            } else if (gameMode === 'relaxed') {
                startGameplay();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            modeButtons.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-3px)';
                });
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        loadStats();
        updateStats();

        const savedMode = localStorage.getItem('quickMathGameMode');
        const savedLevel = localStorage.getItem('quickMathSelectedLevel');

        if (savedMode && savedLevel) {
            level = parseInt(savedLevel);
            gameMode = savedMode;
            localStorage.removeItem('quickMathGameMode');
            localStorage.removeItem('quickMathSelectedLevel');

            document.getElementById('modeSelection').style.display = 'none';
            startGameplay();
        }

        // ============ RANKING GLOBALNY (SUPABASE) ============
        async function saveToLeaderboard(playerScore, mode) {
            if (!currentUser) {
                console.error('No user logged in');
                return;
            }

            // Goście nie zapisują wyników w rankingu
            if (currentUser.isGuest) {
                console.log('Guest mode - score not saved to leaderboard');
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('leaderboard')
                    .insert([
                        {
                            user_id: currentUser.id,
                            player_name: currentUser.username,
                            score: playerScore,
                            game_mode: mode,
                            level: level,
                            created_at: new Date().toISOString()
                        }
                    ]);

                if (error) {
                    console.error('Error saving to leaderboard:', error);
                }
            } catch (err) {
                console.error('Supabase error:', err);
            }
        }

        function saveToLocalLeaderboard(playerScore, mode, playerName) {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            leaderboard.push({
                name: playerName,
                score: playerScore,
                mode: mode,
                level: level,
                date: new Date().toISOString()
            });
            leaderboard.sort((a, b) => b.score - a.score);
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard.slice(0, 100)));
        }

        async function askForPlayerName() {
            const name = prompt('🎮 Podaj swój nick (będzie widoczny w rankingu):', 'Gracz');
            const playerName = name && name.trim() ? name.trim().substring(0, 20) : 'Gracz';
            localStorage.setItem('playerName', playerName);
            return playerName;
        }

        async function showLeaderboard() {
            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                <h2 style="margin-bottom: 20px;">🏆 Ranking Top 10</h2>
                <div style="text-align: center; opacity: 0.7; margin-bottom: 20px;">
                    <div class="loading">Ładowanie rankingu...</div>
                </div>
                <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; margin-top: 20px; cursor: pointer; font-size: 1rem;">
                    ⬅️ Powrót do menu
                </button>
            `;

            try {
                const { data, error } = await supabase
                    .from('leaderboard')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(10);

                if (error) throw error;

                let leaderboardHTML = '<div style="text-align: left; max-height: 400px; overflow-y: auto;">';

                if (!data || data.length === 0) {
                    leaderboardHTML += '<p style="text-align: center; opacity: 0.7;">Brak wyników. Zagraj pierwszą grę!</p>';
                } else {
                    data.forEach((entry, index) => {
                        const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                        const modeIcon = entry.game_mode === 'timed' ? '⚡' : entry.game_mode === 'daily' ? '🌟' : '🧘';

                        leaderboardHTML += `
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 1.5rem; margin-right: 10px;">${medal}</span>
                                    <strong>${entry.player_name}</strong>
                                    <span style="opacity: 0.7; margin-left: 10px;">${modeIcon} Lvl ${entry.level}</span>
                                </div>
                                <div style="font-size: 1.3rem; font-weight: bold; color: #10b981;">
                                    ${entry.score}
                                </div>
                            </div>
                        `;
                    });
                }

                leaderboardHTML += '</div>';

                const playerName = localStorage.getItem('playerName') || 'Gracz';

                document.getElementById('gameContainer').innerHTML = `
                    <h1>NumRun</h1>
                    <h2 style="margin-bottom: 10px;">🏆 Globalny Ranking</h2>
                    <div style="margin-bottom: 20px;">
                        <span style="opacity: 0.8;">Grasz jako: <strong>${playerName}</strong></span>
                        <button onclick="changePlayerName()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 10px; margin-left: 10px; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                            ✏️ Zmień nick
                        </button>
                    </div>
                    ${leaderboardHTML}
                    <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; margin-top: 20px; cursor: pointer; font-size: 1rem;">
                        ⬅️ Powrót do menu
                    </button>
                `;
            } catch (err) {
                console.error('Error loading leaderboard:', err);
                document.getElementById('gameContainer').innerHTML = `
                    <h1>NumRun</h1>
                    <h2 style="margin-bottom: 30px;">🏆 Ranking</h2>
                    <p style="text-align: center; opacity: 0.7; margin-bottom: 20px;">
                        ❌ Nie można załadować rankingu.<br>
                        Sprawdź połączenie z internetem.
                    </p>
                    <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; margin-top: 20px; cursor: pointer; font-size: 1rem;">
                        ⬅️ Powrót do menu
                    </button>
                `;
            }
        }

        async function changePlayerName() {
            const newName = await askForPlayerName();
            showLeaderboard();
        }

        // ============ OSIĄGNIĘCIA ============
        const achievements = [
            { id: 'first_game', name: 'Pierwsze kroki', desc: 'Ukończ pierwszą grę', icon: '🎮', check: () => stats.gamesPlayed >= 1 },
            { id: 'score_100', name: 'Setka!', desc: 'Zdobądź 100 punktów', icon: '💯', check: () => localStorage.getItem('quickMathBestScore') >= 100 },
            { id: 'score_500', name: 'Matematyk', desc: 'Zdobądź 500 punktów', icon: '🧮', check: () => localStorage.getItem('quickMathBestScore') >= 500 },
            { id: 'score_1000', name: 'Mistrz liczb', desc: 'Zdobądź 1000 punktów', icon: '👑', check: () => localStorage.getItem('quickMathBestScore') >= 1000 },
            { id: 'streak_5', name: 'W rytmie', desc: 'Osiągnij streak 5', icon: '🔥', check: () => stats.maxStreak >= 5 },
            { id: 'streak_10', name: 'Niepokonany', desc: 'Osiągnij streak 10', icon: '⚡', check: () => stats.maxStreak >= 10 },
            { id: 'streak_20', name: 'Legenda', desc: 'Osiągnij streak 20', icon: '🌟', check: () => stats.maxStreak >= 20 },
            { id: 'fast_answer', name: 'Błyskawica', desc: 'Odpowiedź <1s', icon: '💨', check: () => stats.fastestTime < 1 },
            { id: 'correct_100', name: 'Stuprocentowy', desc: '100 poprawnych odpowiedzi', icon: '✅', check: () => stats.correctAnswers >= 100 },
            { id: 'level_10', name: 'Do dziesiątki', desc: 'Osiągnij poziom 10', icon: '🚀', check: () => localStorage.getItem('maxLevelReached') >= 10 },
            { id: 'accuracy_95', name: 'Precyzyjny', desc: '95% celność (min. 50 odpowiedzi)', icon: '🎯', check: () => {
                const total = stats.correctAnswers + stats.wrongAnswers;
                return total >= 50 && (stats.correctAnswers / total) >= 0.95;
            }}
        ];

        function checkAchievements() {
            const unlockedAchievements = JSON.parse(localStorage.getItem('achievements') || '[]');
            const newlyUnlocked = [];

            achievements.forEach(achievement => {
                if (!unlockedAchievements.includes(achievement.id) && achievement.check()) {
                    unlockedAchievements.push(achievement.id);
                    newlyUnlocked.push(achievement);
                }
            });

            if (newlyUnlocked.length > 0) {
                localStorage.setItem('achievements', JSON.stringify(unlockedAchievements));
                // Pokaż notyfikację o nowym osiągnięciu
                newlyUnlocked.forEach(ach => {
                    showAchievementNotification(ach);
                });
            }
        }

        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: linear-gradient(45deg, #fbbf24, #f59e0b); color: #000; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 1000; animation: slideIn 0.5s ease-out; max-width: 300px;">
                    <div style="font-size: 2rem; margin-bottom: 5px;">${achievement.icon}</div>
                    <div style="font-weight: bold; font-size: 1.1rem;">Osiągnięcie odblokowane!</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">${achievement.name}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">${achievement.desc}</div>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.5s ease-in';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        function showAchievements() {
            const unlockedAchievements = JSON.parse(localStorage.getItem('achievements') || '[]');

            let achievementsHTML = '<div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">';

            achievements.forEach(achievement => {
                const unlocked = unlockedAchievements.includes(achievement.id);
                const style = unlocked
                    ? 'background: rgba(34, 197, 94, 0.3); border: 2px solid #22c55e;'
                    : 'background: rgba(100, 100, 100, 0.2); border: 2px solid #666; opacity: 0.5;';

                achievementsHTML += `
                    <div style="${style} padding: 15px; border-radius: 10px; display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 2.5rem;">${unlocked ? achievement.icon : '🔒'}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1rem;">${achievement.name}</div>
                            <div style="font-size: 0.85rem; opacity: 0.8;">${achievement.desc}</div>
                        </div>
                        ${unlocked ? '<div style="font-size: 1.5rem;">✓</div>' : ''}
                    </div>
                `;
            });

            achievementsHTML += '</div>';

            const unlockedCount = unlockedAchievements.length;
            const totalCount = achievements.length;

            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                <h2 style="margin-bottom: 10px;">🎖️ Osiągnięcia</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">Odblokowano: ${unlockedCount}/${totalCount}</p>
                ${achievementsHTML}
                <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; margin-top: 20px; cursor: pointer; font-size: 1rem;">
                    ⬅️ Powrót do menu
                </button>
            `;
        }

        // ============ DAILY CHALLENGE ============
        function getDailyChallenge() {
            const today = new Date().toDateString();
            const savedDaily = JSON.parse(localStorage.getItem('dailyChallenge') || '{}');

            if (savedDaily.date === today) {
                return savedDaily;
            }

            // Generuj nowe daily challenge
            const seed = new Date().getDate() + new Date().getMonth() * 31 + new Date().getFullYear() * 365;
            Math.seedrandom = function(seed) {
                const x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };

            const challengeLevel = (seed % 20) + 1;
            const targetScore = [100, 200, 300, 400, 500][seed % 5];

            const newDaily = {
                date: today,
                level: challengeLevel,
                targetScore: targetScore,
                completed: false,
                attempts: 0
            };

            localStorage.setItem('dailyChallenge', JSON.stringify(newDaily));
            return newDaily;
        }

        function completeDailyChallenge(playerScore) {
            const daily = getDailyChallenge();
            daily.attempts++;

            if (playerScore >= daily.targetScore && !daily.completed) {
                daily.completed = true;
                localStorage.setItem('dailyChallenge', JSON.stringify(daily));

                // Bonus za daily challenge
                const bonus = {
                    id: 'daily_' + daily.date,
                    name: 'Daily Challenge',
                    desc: `Ukończono wyzwanie dnia! (${playerScore} pkt)`,
                    icon: '🌟'
                };
                showAchievementNotification(bonus);
            }

            localStorage.setItem('dailyChallenge', JSON.stringify(daily));
        }

        // Aktualizuj funkcję startGame
        const originalStartGame = startGame;
        startGame = function(mode) {
            if (mode === 'daily') {
                const daily = getDailyChallenge();
                level = daily.level;
                gameMode = 'timed';

                alert(`🌟 Daily Challenge\n\nPoziom: ${daily.level}\nCel: ${daily.targetScore} pkt\nPróby dzisiaj: ${daily.attempts}\n\nPowodzenia!`);

                document.getElementById('modeSelection').style.display = 'none';
                startGameplay();
            } else {
                originalStartGame(mode);
            }
        };

        // Dodaj animacje dla powiadomień
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Aktualizuj saveStats aby sprawdzać osiągnięcia
        const originalSaveStats = saveStats;
        saveStats = function() {
            originalSaveStats();
            checkAchievements();
            saveToLeaderboard(score, gameMode);

            // Sprawdź daily challenge
            if (gameMode === 'timed' || gameMode === 'daily') {
                completeDailyChallenge(score);
            }

            // Zapisz maksymalny osiągnięty poziom
            const maxLevel = parseInt(localStorage.getItem('maxLevelReached') || '0');
            if (level > maxLevel) {
                localStorage.setItem('maxLevelReached', level.toString());
            }

            stats.gamesPlayed++;
            localStorage.setItem('quickMathStats', JSON.stringify(stats));
        };

        // ============ AUTHENTICATION SYSTEM ============
        async function showLoginScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('authScreen').innerHTML = `
                <div class="auth-container">
                    <h2 style="text-align: center; margin-bottom: 30px;">🎮 Witaj w NumRun!</h2>

                    <div id="authMessage"></div>

                    <input type="email" id="emailInput" class="auth-input" placeholder="📧 Email">
                    <input type="password" id="passwordInput" class="auth-input" placeholder="🔒 Hasło">

                    <button onclick="handleLogin()" class="auth-btn auth-btn-primary">
                        🚀 Zaloguj się
                    </button>

                    <div class="auth-divider">lub</div>

                    <button onclick="playAsGuest()" class="auth-btn auth-btn-secondary">
                        👻 Zagraj jako gość
                    </button>

                    <p style="text-align: center; opacity: 0.7; font-size: 0.85rem; margin-top: 15px;">
                        Jako gość możesz grać, ale wyniki nie będą zapisywane w rankingu
                    </p>

                    <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <p style="opacity: 0.8; margin-bottom: 10px;">Nie masz jeszcze konta?</p>
                        <button onclick="showRegisterForm()" class="auth-btn auth-btn-secondary">
                            ✨ Zarejestruj się
                        </button>
                    </div>
                </div>
            `;
        }

        function showRegisterForm() {
            document.getElementById('authScreen').innerHTML = `
                <div class="auth-container">
                    <h2 style="text-align: center; margin-bottom: 30px;">✨ Rejestracja</h2>

                    <div id="authMessage"></div>

                    <input type="text" id="usernameInput" class="auth-input" placeholder="👤 Nick (3-20 znaków)" maxlength="20">
                    <input type="email" id="emailInput" class="auth-input" placeholder="📧 Email">
                    <input type="password" id="passwordInput" class="auth-input" placeholder="🔒 Hasło (min. 6 znaków)">

                    <button onclick="handleRegister()" class="auth-btn auth-btn-primary">
                        ✨ Stwórz konto
                    </button>

                    <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
                        <p style="opacity: 0.8; margin-bottom: 10px;">Masz już konto?</p>
                        <button onclick="showLoginScreen()" class="auth-btn auth-btn-secondary">
                            🔐 Zaloguj się
                        </button>
                    </div>
                </div>
            `;
        }

        function playAsGuest() {
            currentUser = {
                id: 'guest',
                username: 'Gość',
                email: null,
                isGuest: true
            };
            localStorage.setItem('playerName', 'Gość');
            showMainMenu();
        }

        async function handleRegister() {
            const username = document.getElementById('usernameInput').value.trim();
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const messageDiv = document.getElementById('authMessage');

            // Walidacja
            if (!username || username.length < 3) {
                messageDiv.innerHTML = '<div class="auth-error">Nick musi mieć co najmniej 3 znaki</div>';
                return;
            }

            if (!email || !email.includes('@')) {
                messageDiv.innerHTML = '<div class="auth-error">Podaj poprawny email</div>';
                return;
            }

            if (!password || password.length < 6) {
                messageDiv.innerHTML = '<div class="auth-error">Hasło musi mieć co najmniej 6 znaków</div>';
                return;
            }

            messageDiv.innerHTML = '<div class="auth-success">⏳ Tworzenie konta...</div>';

            try {
                // Sprawdź czy nick jest unikalny
                const { data: existingUsers, error: checkError } = await supabase
                    .from('users')
                    .select('username')
                    .eq('username', username);

                if (existingUsers && existingUsers.length > 0) {
                    messageDiv.innerHTML = '<div class="auth-error">❌ Ten nick jest już zajęty. Wybierz inny.</div>';
                    return;
                }

                // Rejestracja w Supabase Auth
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username
                        }
                    }
                });

                if (error) {
                    if (error.message.includes('already registered')) {
                        messageDiv.innerHTML = '<div class="auth-error">❌ Ten email jest już zarejestrowany.</div>';
                    } else {
                        messageDiv.innerHTML = '<div class="auth-error">❌ ' + error.message + '</div>';
                    }
                    return;
                }

                // Zapisz użytkownika w tabeli users
                const { error: insertError } = await supabase
                    .from('users')
                    .insert([{
                        id: data.user.id,
                        username: username,
                        email: email
                    }]);

                if (insertError) {
                    console.error('Insert error:', insertError);
                    // Jeśli to błąd unikalności nicku
                    if (insertError.message.includes('duplicate') || insertError.message.includes('unique')) {
                        messageDiv.innerHTML = '<div class="auth-error">❌ Ten nick jest już zajęty. Wybierz inny.</div>';
                        // Usuń konto auth które właśnie stworzyliśmy
                        await supabase.auth.signOut();
                    } else if (insertError.message.includes('row-level security')) {
                        messageDiv.innerHTML = '<div class="auth-error">❌ Błąd uprawnień. Sprawdź konfigurację bazy danych.</div>';
                    } else {
                        messageDiv.innerHTML = '<div class="auth-error">❌ ' + insertError.message + '</div>';
                    }
                    return;
                }

                messageDiv.innerHTML = '<div class="auth-success">✅ Konto utworzone! Zalogowano...</div>';
                currentUser = { id: data.user.id, username: username, email: email };
                localStorage.setItem('playerName', username);

                setTimeout(() => {
                    showMainMenu();
                }, 1500);

            } catch (error) {
                console.error('Registration error:', error);
                messageDiv.innerHTML = `<div class="auth-error">❌ ${error.message}</div>`;
            }
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const messageDiv = document.getElementById('authMessage');

            if (!email || !password) {
                messageDiv.innerHTML = '<div class="auth-error">Wypełnij wszystkie pola</div>';
                return;
            }

            messageDiv.innerHTML = '<div class="auth-success">⏳ Logowanie...</div>';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Pobierz dane użytkownika
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', data.user.id)
                    .single();

                if (userError) throw userError;

                currentUser = userData;
                localStorage.setItem('playerName', userData.username);

                messageDiv.innerHTML = '<div class="auth-success">✅ Zalogowano! Witaj ' + userData.username + '!</div>';

                setTimeout(() => {
                    showMainMenu();
                }, 1500);

            } catch (error) {
                console.error('Login error:', error);
                messageDiv.innerHTML = `<div class="auth-error">❌ Błędny email lub hasło</div>`;
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            localStorage.removeItem('playerName');
            location.reload();
        }

        function showMainMenu() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
        }

        async function showProfile() {
            if (!currentUser) return;

            // Tryb gościa
            if (currentUser.isGuest) {
                document.getElementById('gameContainer').innerHTML = `
                    <h1>NumRun</h1>
                    <h2 style="margin-bottom: 30px;">👻 Tryb Gościa</h2>

                    <div class="profile-avatar">👻</div>
                    <h3 style="text-align: center; margin-bottom: 30px; font-size: 1.5rem;">Gość</h3>

                    <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid rgba(251, 191, 36, 0.5); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                        <p style="margin-bottom: 15px;">⚠️ Grasz jako gość</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Twoje wyniki nie są zapisywane w globalnym rankingu.</p>
                        <p style="font-size: 0.9rem; opacity: 0.8;">Stwórz konto aby zapisywać postępy!</p>
                    </div>

                    <button onclick="handleLogout()" style="background: linear-gradient(45deg, #10b981, #059669); border: none; color: white; padding: 15px 30px; border-radius: 15px; width: 100%; margin-bottom: 10px; cursor: pointer; font-size: 1rem;">
                        ✨ Stwórz konto
                    </button>

                    <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; width: 100%; cursor: pointer; font-size: 1rem;">
                        ⬅️ Powrót do menu
                    </button>
                `;
                return;
            }

            // Zalogowany użytkownik - pobierz statystyki
            const { data: userGames, error } = await supabase
                .from('leaderboard')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('score', { ascending: false });

            const totalGames = userGames ? userGames.length : 0;
            const bestScore = userGames && userGames.length > 0 ? userGames[0].score : 0;
            const avgScore = userGames && userGames.length > 0
                ? Math.round(userGames.reduce((sum, g) => sum + g.score, 0) / userGames.length)
                : 0;

            document.getElementById('gameContainer').innerHTML = `
                <h1>NumRun</h1>
                <h2 style="margin-bottom: 30px;">👤 Profil Gracza</h2>

                <div class="profile-avatar">🎮</div>
                <h3 style="text-align: center; margin-bottom: 30px; font-size: 1.5rem;">${currentUser.username}</h3>

                <div style="margin-bottom: 20px;">
                    <div class="profile-stat">
                        <span>📊 Rozegrane gry:</span>
                        <strong>${totalGames}</strong>
                    </div>
                    <div class="profile-stat">
                        <span>🏆 Najlepszy wynik:</span>
                        <strong>${bestScore}</strong>
                    </div>
                    <div class="profile-stat">
                        <span>📈 Średni wynik:</span>
                        <strong>${avgScore}</strong>
                    </div>
                    <div class="profile-stat">
                        <span>📧 Email:</span>
                        <strong style="font-size: 0.85rem;">${currentUser.email}</strong>
                    </div>
                </div>

                <button onclick="location.reload()" style="background: linear-gradient(45deg, #6366f1, #4f46e5); border: none; color: white; padding: 15px 30px; border-radius: 15px; width: 100%; margin-bottom: 10px; cursor: pointer; font-size: 1rem;">
                    ⬅️ Powrót do menu
                </button>

                <button onclick="handleLogout()" class="logout-btn" style="width: 100%;">
                    🚪 Wyloguj się
                </button>
            `;
        }

        // Sprawdź czy użytkownik jest zalogowany przy starcie
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                // Pobierz dane użytkownika
                const { data: userData } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();

                if (userData) {
                    currentUser = userData;
                    localStorage.setItem('playerName', userData.username);
                    showMainMenu();
                } else {
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        }

        // Rejestracja Service Worker dla PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker zarejestrowany'))
                    .catch(err => console.log('Błąd Service Worker:', err));
            });
        }

        // Uruchom sprawdzanie auth przy załadowaniu strony
        checkAuth();
    </script>
</body>
</html>
